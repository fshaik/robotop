#!/usr/bin/env node

config = require('config')
request = require('request');
Forecast = require('forecast');

var nyc_coor = [40.741895,-73.989308];
var sf_coor = [37.773972, -122.431297];
var me = 1223764231070887;

const coor = nyc_coor;

const winterS3Bucket = "https://s3-us-west-2.amazonaws.com/winter-styles-20";

const PAGE_ACCESS_TOKEN = (process.env.MESSENGER_PAGE_ACCESS_TOKEN) ?
  (process.env.MESSENGER_PAGE_ACCESS_TOKEN) :
  config.get('pageAccessToken');

function callSendAPI(messageData) {
  request({
    uri: 'https://graph.facebook.com/v2.6/me/messages',
    qs: { access_token: PAGE_ACCESS_TOKEN },
    method: 'POST',
    json: messageData

  }, function (error, response, body) {
    if (!error && response.statusCode == 200) {
      var recipientId = body.recipient_id;
      var messageId = body.message_id;

      if (messageId) {
        console.log("Successfully sent message with id %s to recipient %s", 
          messageId, recipientId);
      } else {
      console.log("Successfully called Send API for recipient %s", 
        recipientId);
      }
    } else {
      console.error("Failed calling Send API", response.statusCode, response.statusMessage, body.error);
    }
  });  
}

function sendTextMessage(recipientId, messageText) {
  var messageData = {
    recipient: {
      id: recipientId
    },
    message: {
      text: messageText,
      metadata: "DEVELOPER_DEFINED_METADATA"
    }
  };

  callSendAPI(messageData);
}

function sendImageMessage(recipientId, imageurl) {
  var messageData = {
    recipient: {
      id: recipientId
    },
    message: {
      attachment: {
        type: "image",
        payload: {
          url: imageurl
        }
      }
    }
  };

  callSendAPI(messageData);
}

var forecast = new Forecast({
	service: 'darksky',
	key: '6ee8cd767b474ad54e05898fb5d5e7ac',
	units: 'fahrenheit',
	cache: true,
	ttl: {
		minutes: 27,
		seconds: 45
	}
});

forecast.get(coor, function(err, weather) {
  if(err) return console.dir(err);

  var today = weather.daily.data[0];
  var date = new Date(today.time);
  var apparentTemperatureMin = today.apparentTemperatureMin;
  var precipProbability = today.precipProbability;
  var summary = today.icon;
  var message = "";
  var days = ["Sunday","Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];


  sendTextMessage(me, message
  	.concat("Location: ", weather.timezone)
  	.concat("\nDay: ", date)
  	.concat("\nSummary: ", summary)
  	.concat("\nApparent Temperature: ", apparentTemperatureMin)
  	.concat("\nPrecipitation: ", precipProbability)
   );


  if (apparentTemperatureMin < 30) {
  	sendWinterStyle(30);
  	 
  }

  else if(apparentTemperatureMin < 40) {
  	sendWinterStyle(30)

  }

  else if (apparentTemperatureMin < 50) {
  	sendWinterStyle(40)


  }

  else {

  	sendTextMessage(me, "It's Warm dude! update me")
  }

});

function getRandomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

function sendWinterStyle (temp) {

	switch (temp) {

		case 20:
			sendImageMessage(me, winterS3Bucket.concat("/20/",getRandomInt(1,4),".jpg"));
			break;

		case 30:
			sendImageMessage(me, winterS3Bucket.concat("/30/",getRandomInt(1,4),".jpg"));
			break;

		case 40:
			sendImageMessage(me, winterS3Bucket.concat("/40/",getRandomInt(1,4),".jpg"));
			break;

		default:
			var imageurl = "http://ichef-1.bbci.co.uk/news/320/cpsprodpb/025B/production/_85730600_monkey2.jpg";
	}




}





